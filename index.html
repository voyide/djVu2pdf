<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DjVu to PDF Converter</title>
    
    <!-- Load jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load DjVu.js for decoding -->
    <script src="https://unpkg.com/djvu.js@0.1.6/djvu.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --muted: #94a3b8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: var(--card);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h1 { margin-bottom: 0.5rem; }
        p { color: var(--muted); margin-bottom: 2rem; }

        .drop-zone {
            border: 2px dashed var(--muted);
            border-radius: 8px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--primary);
            background-color: rgba(99, 102, 241, 0.1);
        }

        input[type="file"] {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        #status {
            margin-top: 1.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .progress-container {
            width: 100%;
            background-color: #334155;
            border-radius: 99px;
            height: 10px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.2s;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            display: none;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error { color: #ef4444; margin-top: 10px; font-size: 0.9rem; }
        
        .note {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 2rem;
            border-top: 1px solid #334155;
            padding-top: 1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>DjVu to PDF</h1>
    <p>Convert .djvu files to PDF locally in your browser</p>

    <div class="drop-zone" id="dropZone">
        <span id="dropText">Click or Drag & Drop DjVu file here</span>
        <input type="file" id="fileInput" accept=".djvu">
    </div>

    <div id="status"></div>
    
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <button class="btn" id="downloadBtn">Download PDF</button>

    <div class="note">
        Note: Large files may take time. This tool requires a local server (http://) context to work correctly due to browser security settings.
    </div>
</div>

<script>
    // --- Configuration ---
    // We try to configure the worker path to the CDN. 
    // Note: Cross-origin workers are often blocked by browsers.
    // Ideally, you would host the worker file locally.
    if (window.DjVu) {
        DjVu.Worker.path = 'https://unpkg.com/djvu.js@0.1.6/djvu_worker.js';
    }

    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const statusEl = document.getElementById('status');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const downloadBtn = document.getElementById('downloadBtn');
    
    let currentPdfBlob = null;
    let fileName = "converted.pdf";

    // --- UI Event Listeners ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', () => dropZone.classList.remove('dragover'));

    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            processFile(file);
        }
    }

    // --- Core Logic ---
    async function processFile(file) {
        if (!file.name.toLowerCase().endsWith('.djvu')) {
            statusEl.innerHTML = "<span class='error'>Please upload a valid .djvu file</span>";
            return;
        }

        // Reset UI
        downloadBtn.style.display = 'none';
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        statusEl.textContent = "Loading file...";
        fileName = file.name.replace(/\.djvu$/i, ".pdf");

        try {
            const arrayBuffer = await readFileAsArrayBuffer(file);
            statusEl.textContent = "Initializing Decoder...";
            
            // Create DjVu Document
            const doc = new DjVu.Document(arrayBuffer);
            
            // Wait for metadata to load
            await doc.ready; // This ensures pages count is available
            
            const pageCount = doc.pages.length;
            statusEl.textContent = `Found ${pageCount} pages. Starting conversion...`;

            // Initialize PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            // Loop through pages
            for (let i = 0; i < pageCount; i++) {
                // Update UI
                const percent = Math.round(((i) / pageCount) * 100);
                progressBar.style.width = `${percent}%`;
                statusEl.textContent = `Converting page ${i + 1} of ${pageCount}...`;

                // Give the UI a moment to breathe so the browser doesn't freeze
                await new Promise(r => setTimeout(r, 10));

                const page = doc.pages[i];
                
                // Render page to an ImageData object
                // We request the page with a slight delay to allow worker communication
                const imageBuffer = await page.render({
                    scale: 2, // Higher scale = better quality but slower/larger
                    rotation: 0
                });

                // Convert ImageData to Canvas to get DataURL
                const canvas = document.createElement('canvas');
                canvas.width = imageBuffer.width;
                canvas.height = imageBuffer.height;
                const ctx = canvas.getContext('2d');
                const imageData = new ImageData(
                    new Uint8ClampedArray(imageBuffer.buffer), 
                    imageBuffer.width, 
                    imageBuffer.height
                );
                ctx.putImageData(imageData, 0, 0);

                // Compress to JPEG for PDF size management
                const imgData = canvas.toDataURL('image/jpeg', 0.75);

                // Add to PDF
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                if (i > 0) pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            }

            progressBar.style.width = '100%';
            statusEl.textContent = "Conversion Complete! Preparing download...";
            
            currentPdfBlob = pdf.output('blob');
            
            downloadBtn.style.display = 'inline-block';
            downloadBtn.textContent = "Download " + fileName;
            statusEl.textContent = "Ready.";

        } catch (err) {
            console.error(err);
            statusEl.innerHTML = `<span class='error'>Error: ${err.message}<br><br>If this is a "Worker" error, please run this HTML file on a local server (localhost) instead of opening it directly.</span>`;
        }
    }

    function readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    downloadBtn.addEventListener('click', () => {
        if (currentPdfBlob) {
            const url = URL.createObjectURL(currentPdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    });
</script>

</body>
</html>
